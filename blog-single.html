<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ovqat Buyurtma - Admin & User</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="text-center mb-4">üçî Ovqat Buyurtma tizimi</h1>

  <!-- REGISTER -->
  <div class="card p-3 mb-3">
    <h4>Ro'yxatdan o'tish</h4>
    <input id="reg-phone" class="form-control mb-2" placeholder="Telefon raqam">
    <input id="reg-pass" type="password" class="form-control mb-2" placeholder="Parol">
    <button class="btn btn-success w-100" onclick="register()">Ro'yxatdan o'tish</button>
  </div>

  <!-- LOGIN -->
  <div class="card p-3 mb-3">
    <h4>Kirish</h4>
    <input id="login-phone" class="form-control mb-2" placeholder="Telefon raqam">
    <input id="login-pass" type="password" class="form-control mb-2" placeholder="Parol">
    <button class="btn btn-primary w-100" onclick="login()">Kirish</button>
  </div>

  <!-- FOODS CRUD -->
  <div class="card p-3 mb-3">
    <h4>Ovqatlar ro'yxati (Admin CRUD)</h4>
    <input id="food-name" class="form-control mb-2" placeholder="Ovqat nomi">
    <input id="food-type" class="form-control mb-2" placeholder="Turi (ovqat/shirinlik/ichimlik)">
    <input id="food-price" type="number" class="form-control mb-2" placeholder="Narxi">
    <button class="btn btn-primary mb-2 w-100" onclick="addFood()">Ovqat qo'shish</button>
    <div id="foods" class="row"></div>
  </div>

  <h3 class="mb-2">Buyurtmalar</h3>
  <pre id="orders" class="bg-white p-2"></pre>

  <pre id="result" class="bg-white p-2"></pre>
</div>

<script>
const API = "https://foodshoping.quizsite.uz/api";
let accessToken = "";

// üîπ LOAD FOODS
async function loadFoods() {
  const res = await fetch(API + "/foods/", {
    headers: accessToken ? { "Authorization": "Bearer " + accessToken } : {}
  });
  const data = await res.json();
  const foodsDiv = document.getElementById("foods");
  foodsDiv.innerHTML = "";

  data.results.forEach(food => {
    foodsDiv.innerHTML += `
      <div class="col-md-3 mb-3">
        <div class="card h-100 shadow-sm p-2">
          <h5>${food.nomi}</h5>
          <p>${food.turi}</p>
          <strong>${food.narxi} ming</strong><br>
          <button class="btn btn-warning btn-sm mt-1" onclick="updateFood(${food.id})">Update</button>
          <button class="btn btn-danger btn-sm mt-1" onclick="deleteFood(${food.id})">Delete</button>
        </div>
      </div>`;
  });
}

// üîπ ADD FOOD (Admin)
async function addFood() {
  if(!accessToken) { alert("Login qiling"); return; }

  const nomi = document.getElementById("food-name").value;
  const turi = document.getElementById("food-type").value;
  const narxi = Number(document.getElementById("food-price").value);

  const res = await fetch(API + "/foods/", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + accessToken
    },
    body: JSON.stringify({ nomi, turi, narxi, mavjud:true })
  });
  const data = await res.json();
  document.getElementById("result").innerText = JSON.stringify(data,null,2);
  loadFoods();
}

// üîπ UPDATE FOOD (Admin, PUT)
async function updateFood(id) {
  if(!accessToken) { alert("Login qiling"); return; }

  const nomi = prompt("Yangi nomi:");
  const turi = prompt("Yangi turi:");
  const narxi = prompt("Yangi narxi:");

  const res = await fetch(API + "/foods/" + id + "/", {
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + accessToken
    },
    body: JSON.stringify({ nomi, turi, narxi: Number(narxi), mavjud:true })
  });
  const data = await res.json();
  document.getElementById("result").innerText = JSON.stringify(data,null,2);
  loadFoods();
}

// üîπ DELETE FOOD
async function deleteFood(id) {
  if(!accessToken) { alert("Login qiling"); return; }
  if(!confirm("O'chirishni tasdiqlaysizmi?")) return;

  const res = await fetch(API + "/foods/" + id + "/", {
    method:"DELETE",
    headers:{
      "Authorization":"Bearer " + accessToken
    }
  });
  if(res.status===204){
    alert("O'chirildi");
  }
  loadFoods();
}

// üîπ REGISTER
async function register() {
  const phone = document.getElementById("reg-phone").value;
  const password = document.getElementById("reg-pass").value;
  const res = await fetch(API + "/register/", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone, password })
  });
  const data = await res.json();
  document.getElementById("result").innerText = JSON.stringify(data,null,2);
}

// üîπ LOGIN
async function login() {
  const phone = document.getElementById("login-phone").value;
  const password = document.getElementById("login-pass").value;
  const res = await fetch(API + "/token/", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ phone, password })
  });
  const data = await res.json();
  document.getElementById("result").innerText = JSON.stringify(data,null,2);
  if(data.access){
    accessToken = data.access;
    loadFoods();
    loadOrders();
  }
}

// üîπ LOAD ORDERS
async function loadOrders() {
  if(!accessToken) return;
  const res = await fetch(API + "/my-orders/", {
    headers:{ "Authorization":"Bearer "+accessToken }
  });
  const data = await res.json();
  document.getElementById("orders").innerText = JSON.stringify(data,null,2);
}

// Initial load
loadFoods();
</script>
</body>
</html>
